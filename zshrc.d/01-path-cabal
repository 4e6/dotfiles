## symlink cabal sandboxed projects
#
# file `cabal_projects/project_name/links` list executables that should be
# linked to `local_bin`, if not exists `project_name` will be used as fallback

zmodload zsh/mapfile

local cabal_projects=~/projects/cabal
local local_bin=~/bin

broken_symlinks () {
  local dir=$1
  echo $dir/*(N-@)
}

local_cabal_executable () {
  local project="$1"
  local name="$2"
  echo "$project/.cabal-sandbox/bin/$name"
}

local_make_symlink () {
  local filename=$1
  local linkname=$2
  [[ ! -h $linkname ]] && [[ -x $filename ]] && ln -v -s $filename $linkname
}

# remove dead links from local path
local deadlinks=$(broken_symlinks $local_bin)
[[ -n $deadlinks ]] && rm -v $deadlinks

# symlink cabal executables to local path
for project in ~/projects/cabal/*(N); do
  local -a filenames
  if [[ -f "$project/links" ]]; then
    filenames=("${(f@)mapfile[$project/links]}")
  else
    filenames=("$(basename $project)")
  fi

  for filename in $filenames; do
    local symlink=$local_bin/$filename
    local exe=$(local_cabal_executable $project $filename)
    local_make_symlink $exe $symlink
  done
done
